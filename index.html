<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NZMA EFT Calculator</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@400;500&family=Lora:wght@600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f4f6f9;
    --surface: #ffffff;
    --surface2: #eef1f6;
    --border: #d4d9e4;
    --border-hover: #b0b8cc;
    --accent: #1a6b4a;
    --accent-light: #e6f4ee;
    --accent2: #c0392b;
    --accent2-light: #fdecea;
    --accent3: #b5680a;
    --accent3-light: #fff4e0;
    --accent4: #1a4fa0;
    --accent4-light: #e8eef9;
    --text: #1a1f2e;
    --text-muted: #6b7494;
    --radius: 12px;
    --shadow: 0 1px 4px rgba(0,0,0,0.07), 0 4px 16px rgba(0,0,0,0.05);
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Inter', sans-serif;
    min-height: 100vh;
    padding: 2rem 1rem 4rem;
  }

  .container { max-width: 900px; margin: 0 auto; }

  header {
    margin-bottom: 2rem;
    padding-bottom: 1.5rem;
    border-bottom: 2px solid var(--border);
    display: flex;
    align-items: baseline;
    gap: 1rem;
    flex-wrap: wrap;
  }

  header h1 {
    font-family: 'Lora', serif;
    font-size: 2rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    color: var(--accent);
  }

  header span {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--text-muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 1.75rem;
    margin-bottom: 1.25rem;
    box-shadow: var(--shadow);
    transition: border-color 0.2s;
  }

  .card:hover { border-color: var(--border-hover); }

  .card-title {
    font-size: 0.68rem;
    font-family: 'DM Mono', monospace;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--text-muted);
    margin-bottom: 1.25rem;
    display: flex;
    align-items: center;
    gap: 0.6rem;
  }

  .card-title::before {
    content: '';
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    background: var(--accent);
    flex-shrink: 0;
  }

  .card-title.red::before   { background: var(--accent2); }
  .card-title.yellow::before { background: var(--accent3); }
  .card-title.blue::before   { background: var(--accent4); }

  label {
    display: block;
    font-size: 0.75rem;
    font-family: 'DM Mono', monospace;
    color: var(--text-muted);
    margin-bottom: 0.45rem;
    letter-spacing: 0.05em;
    text-transform: uppercase;
  }

  select, input[type="number"], input[type="date"] {
    width: 100%;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'Inter', sans-serif;
    font-size: 0.95rem;
    padding: 0.7rem 1rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
    appearance: none;
    -webkit-appearance: none;
  }

  select {
    cursor: pointer;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7494' d='M6 8L1 3h10z'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    background-color: var(--surface2);
    padding-right: 2.5rem;
  }

  select:focus, input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px rgba(26,107,74,0.12);
    background: #fff;
  }

  input[type="date"]::-webkit-calendar-picker-indicator { opacity: 0.5; cursor: pointer; }

  .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
  @media (max-width: 560px) { .row2 { grid-template-columns: 1fr; } }

  .field { margin-bottom: 1rem; }
  .field:last-child { margin-bottom: 0; }

  .result-box {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 1.25rem 1.5rem;
    margin-top: 1.25rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 1rem;
    flex-wrap: wrap;
  }

  .result-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.68rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin-bottom: 0.3rem;
  }

  .result-value {
    font-family: 'Lora', serif;
    font-size: 2.2rem;
    font-weight: 700;
    letter-spacing: -0.02em;
    color: var(--accent);
    line-height: 1;
  }

  .result-value.red    { color: var(--accent2); }
  .result-value.yellow { color: var(--accent3); }
  .result-value.blue   { color: var(--accent4); }

  .formula-text {
    font-family: 'DM Mono', monospace;
    font-size: 0.82rem;
    color: var(--text-muted);
  }

  .eft-badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    background: var(--accent-light);
    border: 1px solid rgba(26,107,74,0.2);
    border-radius: 6px;
    padding: 0.35rem 0.85rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--accent);
    margin-top: 0.75rem;
    font-weight: 500;
  }

  /* Funding type toggle */
  .funding-toggle {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1.25rem;
    flex-wrap: wrap;
  }

  .fund-btn {
    flex: 1;
    min-width: 80px;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-muted);
    font-family: 'Inter', sans-serif;
    font-size: 0.85rem;
    font-weight: 600;
    padding: 0.65rem 1rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .fund-btn:hover { border-color: var(--border-hover); color: var(--text); }

  .fund-btn.active {
    background: var(--accent4-light);
    border-color: rgba(26,79,160,0.35);
    color: var(--accent4);
  }

  .na-notice {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 0.85rem 1.1rem;
    font-size: 0.82rem;
    color: var(--text-muted);
    font-style: italic;
    margin-top: 0.5rem;
  }

  /* Mode toggle */
  .toggle-row { display: flex; gap: 0.5rem; margin-bottom: 1.25rem; }

  .toggle-btn {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text-muted);
    font-family: 'Inter', sans-serif;
    font-size: 0.85rem;
    font-weight: 600;
    padding: 0.65rem 1rem;
    cursor: pointer;
    transition: all 0.2s;
  }

  .toggle-btn:hover { border-color: var(--border-hover); color: var(--text); }

  .toggle-btn.active {
    background: var(--accent-light);
    border-color: rgba(26,107,74,0.35);
    color: var(--accent);
  }

  .toggle-btn.active.red {
    background: var(--accent2-light);
    border-color: rgba(192,57,43,0.3);
    color: var(--accent2);
  }

  .mode-panel { display: none; }
  .mode-panel.visible { display: block; }

  /* Stats grid */
  .three-col {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 1rem;
    margin-top: 1rem;
  }

  @media (max-width: 640px) { .three-col { grid-template-columns: 1fr 1fr; } }
  @media (max-width: 380px)  { .three-col { grid-template-columns: 1fr; } }

  .mini-stat {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1rem 1.25rem;
    text-align: center;
  }

  .mini-stat .val {
    font-family: 'Lora', serif;
    font-size: 1.5rem;
    font-weight: 700;
    margin-bottom: 0.3rem;
    line-height: 1;
  }

  .mini-stat .lbl {
    font-family: 'DM Mono', monospace;
    font-size: 0.6rem;
    color: var(--text-muted);
    text-transform: uppercase;
    letter-spacing: 0.08em;
  }

  .date-note {
    font-size: 0.82rem;
    color: var(--text-muted);
    margin-top: 0.85rem;
    line-height: 1.7;
  }

  .date-note strong { color: var(--text); font-weight: 600; }

  .shutdown-note {
    display: flex;
    align-items: flex-start;
    gap: 0.6rem;
    background: var(--accent3-light);
    border: 1px solid rgba(181,104,10,0.2);
    border-radius: 8px;
    padding: 0.75rem 1rem;
    margin-top: 1rem;
    font-size: 0.8rem;
    color: var(--accent3);
    line-height: 1.5;
  }

  .shutdown-note .icon { flex-shrink: 0; font-size: 1rem; }

  p.helper {
    font-size: 0.83rem;
    color: var(--text-muted);
    margin-bottom: 1.25rem;
    line-height: 1.6;
  }

  /* Date section layout: start date prominent, end date secondary */
  .date-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
    margin-top: 1rem;
    align-items: start;
  }

  @media (max-width: 560px) { .date-grid { grid-template-columns: 1fr; } }

  .end-date-wrapper {
    opacity: 0.7;
    transition: opacity 0.2s;
  }

  .end-date-wrapper:focus-within { opacity: 1; }

  .end-date-label-note {
    font-size: 0.68rem;
    color: var(--text-muted);
    font-family: 'DM Mono', monospace;
    margin-top: 0.3rem;
    letter-spacing: 0.03em;
  }

  .auto-badge {
    display: inline-block;
    background: var(--accent-light);
    color: var(--accent);
    border: 1px solid rgba(26,107,74,0.2);
    border-radius: 4px;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    padding: 0.1rem 0.4rem;
    margin-left: 0.4rem;
    vertical-align: middle;
  }
</style>
</head>
<body>
<div class="container">
  <header>
    <h1>NZMA EFT Calculator</h1>
    <span>Equivalent Full-Time Student Tool</span>
  </header>

  <!-- Step 1: Qualification -->
  <div class="card">
    <div class="card-title">Step 1 ‚Äî Select Programme</div>
    <div class="field">
      <label>Programme</label>
      <select id="qualSelect">
        <option value="">‚Äî Choose a programme ‚Äî</option>
      </select>
    </div>
    <div id="eftBadge" style="display:none;">
      <div class="eft-badge">EFT rate per student: <strong id="eftRateDisplay">‚Äî</strong> &nbsp;|&nbsp; Default programme length: <strong id="weekLengthDisplay">‚Äî</strong> weeks</div>
    </div>
  </div>

  <!-- Step 2: Calculation Mode -->
  <div class="card">
    <div class="card-title">Step 2 ‚Äî Calculation Mode</div>
    <div class="toggle-row">
      <button class="toggle-btn active" id="btnStudents" onclick="setMode('students')">Students ‚Üí EFT</button>
      <button class="toggle-btn red"    id="btnEft"      onclick="setMode('eft')">EFT ‚Üí Students</button>
    </div>

    <!-- Students ‚Üí EFT -->
    <div class="mode-panel visible" id="panelStudents">
      <div class="field">
        <label>Number of Students</label>
        <input type="number" id="studentCount" min="1" placeholder="e.g. 20" oninput="calcFromStudents()">
      </div>
      <div class="result-box" id="resultStudents" style="display:none;">
        <div>
          <div class="result-label">Total EFT</div>
          <div class="result-value" id="eftResult">‚Äî</div>
        </div>
        <div style="text-align:right;">
          <div class="result-label">Calculation</div>
          <div class="formula-text" id="calcFormula">‚Äî</div>
        </div>
      </div>
    </div>

    <!-- EFT ‚Üí Students -->
    <div class="mode-panel" id="panelEft">
      <div class="field">
        <label>Target EFT Amount</label>
        <input type="number" id="eftTarget" min="0.001" step="0.001" placeholder="e.g. 10.5" oninput="calcFromEft()">
      </div>
      <div class="result-box" id="resultEft" style="display:none;">
        <div>
          <div class="result-label">Students Required</div>
          <div class="result-value red" id="studentsResult">‚Äî</div>
        </div>
        <div style="text-align:right;">
          <div class="result-label">Exact / Rounded Up</div>
          <div class="formula-text" id="exactStudents">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Step 3: Funding Value -->
  <div class="card">
    <div class="card-title blue">Step 3 ‚Äî Funding Value</div>
    <p class="helper">Select a funding type to calculate the total funding value based on your EFT total above. Rates shown are per EFT unit.</p>
    <div class="funding-toggle">
      <button class="fund-btn active" id="fundDQ37"  onclick="setFunding('DQ3-7')">DQ3‚Äì7</button>
      <button class="fund-btn"        id="fundYG"    onclick="setFunding('YG')">YG</button>
      <button class="fund-btn"        id="fundDQ12"  onclick="setFunding('DQ1-2')">DQ1‚Äì2</button>
    </div>
    <div id="fundingNa" class="na-notice" style="display:none;">
      This funding type is not available for the selected programme.
    </div>
    <div class="result-box" id="fundingResult" style="display:none;">
      <div>
        <div class="result-label">Total Funding Value</div>
        <div class="result-value blue" id="fundingValue">‚Äî</div>
      </div>
      <div style="text-align:right;">
        <div class="result-label">Calculation</div>
        <div class="formula-text" id="fundingFormula">‚Äî</div>
      </div>
    </div>
  </div>

  <!-- Step 4: Year Weighting -->
  <div class="card">
    <div class="card-title yellow">Step 4 ‚Äî Year Weighting (Optional)</div>
    <p class="helper">Enter a class start date ‚Äî the end date will default to the programme's standard week length, extended to account for the holiday shutdown if needed. You can override the end date manually. The holiday shutdown (14 Dec ‚Äì 15 Jan) adds to the calendar length of the programme but is excluded from EFT-counted weeks.</p>

    <div class="date-grid">
      <div class="field">
        <label>Class Start Date</label>
        <input type="date" id="startDate" oninput="onStartDateChange()">
      </div>
      <div class="end-date-wrapper field">
        <label>Class End Date <span class="auto-badge" id="autoEndBadge" style="display:none;">auto</span></label>
        <input type="date" id="endDate" oninput="calcDateWeight()">
        <div class="end-date-label-note" id="endDateNote" style="display:none;">Defaulted from programme week length. Edit to override.</div>
      </div>
    </div>

    <div id="dateResults" style="display:none;">
      <div class="three-col">
        <div class="mini-stat">
          <div class="val" id="totalWeeks" style="color:var(--text);">‚Äî</div>
          <div class="lbl">Total Calendar Weeks (incl. shutdown)</div>
        </div>
        <div class="mini-stat">
          <div class="val" id="eftWeeks" style="color:var(--text-muted);">‚Äî</div>
          <div class="lbl">EFT Weeks (excl. shutdown)</div>
        </div>
        <div class="mini-stat">
          <div class="val" id="weeksInYear" style="color:var(--accent3);">‚Äî</div>
          <div class="lbl">EFT Weeks in <span id="currentYearLabel"></span></div>
        </div>
        <div class="mini-stat">
          <div class="val" id="yearPercent" style="color:var(--accent);">‚Äî</div>
          <div class="lbl">Year %</div>
        </div>
      </div>

      <div id="shutdownNotice" style="display:none;">
        <div class="shutdown-note">
          <span class="icon">üèñÔ∏è</span>
          <span id="shutdownText"></span>
        </div>
      </div>

      <div class="result-box" style="margin-top:1rem;">
        <div>
          <div class="result-label">Year-Weighted EFT</div>
          <div class="result-value yellow" id="weightedEft">‚Äî</div>
        </div>
        <div style="text-align:right;">
          <div class="result-label">Formula</div>
          <div class="formula-text" id="weightFormula">‚Äî</div>
        </div>
      </div>

      <div class="result-box" id="weightedStudentsBox" style="margin-top:0.75rem; display:none; background:var(--accent2-light); border-color:rgba(192,57,43,0.2);">
        <div>
          <div class="result-label">Students needed to reach your EFT target<br><span style="font-size:0.65rem;opacity:0.7;">(accounting for year weighting)</span></div>
          <div class="result-value red" id="weightedStudentsResult">‚Äî</div>
        </div>
        <div style="text-align:right;">
          <div class="result-label">Exact / Rounded Up</div>
          <div class="formula-text" id="weightedStudentsFormula">‚Äî</div>
        </div>
      </div>

      <div class="result-box" id="weightedFundingBox" style="margin-top:0.75rem; display:none; background:var(--accent4-light); border-color:rgba(26,79,160,0.2);">
        <div>
          <div class="result-label">Year-Weighted Funding Value</div>
          <div class="result-value blue" id="weightedFundingValue">‚Äî</div>
        </div>
        <div style="text-align:right;">
          <div class="result-label">Formula</div>
          <div class="formula-text" id="weightedFundingFormula">‚Äî</div>
        </div>
      </div>

      <div class="date-note" id="dateNote"></div>
    </div>
  </div>
</div>

<script>
// Programme data: [code, name, eft, dq37, yg, dq12, weeks]
// null = N/A for that funding type
const programmes = [
  ["ANML3 OL",        "Animal Care L3",                                              0.5833,  6584.00,     null,     null,  40],
  ["CONSPL5 OL",      "Construction Supervision L5 Online",                           0.5838, 10992.00,     null,     null,  45],
  ["CONCML5 OL",      "Construction Commercial L5 Online",                            0.5838, 10992.00,     null,     null,  45],
  ["DLNL4 PT OL",     "Diverse Learning Needs L4",                                    0.333,   6584.00,     null,     null,  40],
  ["SMBL4 OL",        "Small Business Management L4",                                 0.5,     6584.00,     null,     null,  36],
  ["FLML4 OL",        "First Line Management L4",                                     0.5,     6584.00,     null,     null,  36],
  ["LSCPL3 OL",       "Landscape Design L3",                                          0.625,  12375.00,     null,     null,  40],
  ["HORTL3 OL",       "Horticulture L3 - Online Part Time",                           0.5,    12375.00,     null,     null,  32],
  ["BAKEL4",          "Baking L4",                                                    1,      10992.00,     null,     null,  39],
  ["COOKGL5",         "Cookery L5",                                                   1,      10992.00,     null,     null,  40],
  ["COOKL4",          "Cookery L4",                                                   1,      10992.00,     null,     null,  40],
  ["CONL3",           "Construction L3",                                              1,      10992.00,  12434.00,    null,  37],
  ["CTSPP",           "Paint and Plaster L3",                                         0.5,    10992.00,     null,     null,  20],
  ["ECEL4",           "Early Childhood Education L4",                                 0.5,     6584.00,     null,     null,  20],
  ["ECEL5",           "Early Childhood Education L5",                                 1,       6584.00,     null,     null,  44],
  ["EET",             "Electrical L3",                                                1,      10992.00,  16607.00,    null,  39],
  ["EXERL4",          "Personal Training L4",                                         0.5,    11406.65,     null,     null,  20],
  ["EXERL4 ONL FT",   "Personal Training L4 - Online Full Time",                      0.5,    11406.65,     null,     null,  18],
  ["EXERL4 ONL PT",   "Personal Training L4 - Online Part Time",                      0.5,    11406.65,     null,     null,  36],
  ["EXERL5",          "Advanced Fitness Coach L5",                                    0.5,    12375.00,     null,     null,  20],
  ["F&BL3",           "Food and Beverage L3",                                         0.5,     6584.00,  12434.00,    null,  20],
  ["F&BL4",           "Food and Beverage L4",                                         0.5,    10992.00,     null,     null,  19],
  ["FNDSKI",          "Foundation Skills L2",                                         0.5,       null,  12434.00,    null,  19],
  ["HELWL3",          "Health and Wellbeing L3",                                      0.5833,  6584.00,  12434.00,    null,  21],
  ["HELWL4",          "Health and Wellbeing L4",                                      1,       6835.67,     null,     null,  39],
  ["HOSML5",          "Hospitality L5",                                               1,       6584.00,     null,     null,  39],
  ["HOSML6",          "Hospitality L6",                                               1,       6584.00,     null,     null,  44],
  ["PGD",             "Plumbing L3",                                                  0.6,    10992.00,  16607.00,    null,  21],
  ["PHARM3",          "Pharmacy L3",                                                  0.35,   10992.00,     null,     null,  14],
  ["PHARM5",          "Pharmacy L5",                                                  1.1668, 10992.00,     null,     null,  47],
  ["PNURL4",          "Pre-Nursing L4",                                               0.5,       null,     null,     null,  20],
  ["PPREL3",          "Pre-Police L3",                                                0.5,     6584.00,  12434.00,    null,  20],
  ["SRECL3",          "Sports Rec L3",                                                0.5,     6584.00,  12434.00,    null,  20],
  ["SRECL5",          "Sports Rec L5",                                                1,      10203.38,     null,     null,  44],
  ["SRECL6",          "Sports Rec L6",                                                1,      10266.59,     null,     null,  44],
  ["CONL6",           "Construction Management L6",                                   1,         null,     null,     null,  74],
  ["BATL3 PT",        "Business Admin & Technology L3 - Part Time",                   0.5,     6584.00,     null,     null,  38],
  ["BATL3 FT",        "Business Admin & Technology L3 - Full Time",                   0.5,     6584.00,     null,     null,  19],
  ["BCATS",           "BCATS Trades L2",                                              0.6667,    null,  16607.00,    null,  27],
  ["LBT-APICL3 PT",   "Apiculture Level 3",                                           0.5417, 12375.00,     null,     null,  40],
  ["LBT-PESTOPL3 CS", "Pest Operations Level 3",                                      0.5001, 12375.00,     null,     null,  19],
  ["LBT-PESTOPL3 OL", "Pest Operations Level 3 - Online Part Time",                   0.5001, 12375.00,     null,     null,  40],
  ["LBT-PIOSL3 INF",  "Primary Industry Op Skills L3 - Infrastructure",               0.4169, 12375.00,  16607.00,    null,  16],
  ["LBT-PIOSL3 RUR",  "Primary Industry Op Skills L3 - Rural Operational Skills",     0.335,  12375.00,  16607.00,    null,  13],
  ["LBT-PIOSL3 SE",   "Primary Industry Op Skills L3 - Specialist Equipment",         0.4169, 12375.00,  16607.00,    null,  16],
  ["LBT-PIOSL3 SEI",  "Primary Industry Op Skills L3 - Specialist Equipment & Infrastructure", 0.5003, 12375.00, 16607.00, null, 20],
  ["LBT-PRODL5",      "Primary Industry Production Management Level 5",               0.5833, 12375.00,     null,     null,  40],
  ["LBT-AGRIL2 SF",   "Vocational Pathways - PI - Agriculture L2",                    0.667,     null,  16607.00, 15498.00,  26],
  ["LBT-AGRIL4 D",    "Agriculture Level 4 - Dairy",                                  1.0417, 12375.00,     null,     null,  44],
  ["LBT-AGRIL4 BL",   "Agriculture Level 4 - Breeding Livestock",                     1,      12375.00,     null,     null,  44],
  ["LBT-AGRIL4 NBL",  "Agriculture Level 4 - Non Breeding Livestock",                 0.8333, 12375.00,     null,     null,  44],
  ["LBT-FARMSL3 DS",  "Agriculture Farming Systems Level 3",                          0.7084, 12375.00,     null,     null,  28],
  ["LBT-HORTL2",      "Vocational Pathways - PI - Horticulture L2",                   0.6667,    null,  16607.00, 15498.00,  26],
  ["LBT-HORTL3 FT",   "Horticulture Level 3",                                         0.5,    12375.00,     null,     null,  20],
  ["LBT-SUSSL4 FT",   "Sustainable Primary Production Level 4",                       0.5833, 12375.00,     null,     null,  22],
  ["LBT-BCATSL2",     "Vocational Pathways - C&I - BCATS",                            0.6667,    null,  16607.00, 15498.00,  26],
  ["LBT-CIVIL2",      "Vocational Pathways - C&I - Civil",                            0.6667,    null,  16607.00, 15498.00,  26],
];

// Sort by name and populate dropdown
programmes.sort((a, b) => a[1].localeCompare(b[1]));

const sel = document.getElementById('qualSelect');
programmes.forEach((p, i) => {
  const opt = document.createElement('option');
  opt.value = i;
  opt.textContent = `${p[1]}  (EFT: ${p[2]})`;
  sel.appendChild(opt);
});

// State
let currentProg    = null; // full programme row
let currentEftRate = null;
let currentWeeks   = null;
let currentMode    = 'students';
let currentFunding = 'DQ3-7';
let computedEftTotal = null;
let endDateManuallySet = false;

// Funding type index: dq37=3, yg=4, dq12=5
const fundingIndex = { 'DQ3-7': 3, 'YG': 4, 'DQ1-2': 5 };

sel.addEventListener('change', () => {
  const idx = parseInt(sel.value);
  if (isNaN(idx)) {
    currentProg = null; currentEftRate = null; currentWeeks = null;
    document.getElementById('eftBadge').style.display = 'none';
  } else {
    currentProg    = programmes[idx];
    currentEftRate = currentProg[2];
    currentWeeks   = currentProg[6];
    document.getElementById('eftRateDisplay').textContent    = currentEftRate;
    document.getElementById('weekLengthDisplay').textContent = currentWeeks;
    document.getElementById('eftBadge').style.display = 'block';
    // Auto-set end date if start date is already entered
    applyDefaultEndDate();
  }
  recalcAll();
});

function setMode(mode) {
  currentMode = mode;
  document.getElementById('btnStudents').classList.toggle('active', mode === 'students');
  document.getElementById('btnEft').classList.toggle('active', mode === 'eft');
  document.getElementById('panelStudents').classList.toggle('visible', mode === 'students');
  document.getElementById('panelEft').classList.toggle('visible', mode === 'eft');
  recalcAll();
}

function setFunding(type) {
  currentFunding = type;
  ['DQ3-7','YG','DQ1-2'].forEach(t => {
    const id = { 'DQ3-7': 'fundDQ37', 'YG': 'fundYG', 'DQ1-2': 'fundDQ12' }[t];
    document.getElementById(id).classList.toggle('active', t === type);
  });
  updateFundingDisplay();
}

function calcFromStudents() {
  const n = parseFloat(document.getElementById('studentCount').value);
  const box = document.getElementById('resultStudents');
  if (!currentEftRate || isNaN(n) || n <= 0) {
    box.style.display = 'none';
    computedEftTotal = null;
    updateFundingDisplay();
    calcDateWeight();
    return;
  }
  const total = n * currentEftRate;
  computedEftTotal = total;
  document.getElementById('eftResult').textContent   = total.toFixed(4);
  document.getElementById('calcFormula').textContent = `${n} √ó ${currentEftRate} = ${total.toFixed(4)}`;
  box.style.display = 'flex';
  updateFundingDisplay();
  calcDateWeight();
}

function calcFromEft() {
  const t = parseFloat(document.getElementById('eftTarget').value);
  const box = document.getElementById('resultEft');
  if (!currentEftRate || isNaN(t) || t <= 0) {
    box.style.display = 'none';
    computedEftTotal = null;
    updateFundingDisplay();
    calcDateWeight();
    return;
  }
  const exact = t / currentEftRate;
  const rounded = Math.ceil(exact);
  computedEftTotal = t;
  document.getElementById('studentsResult').textContent = rounded;
  document.getElementById('exactStudents').textContent  = `Exact: ${exact.toFixed(3)} ‚Üí ‚Üë${rounded}`;
  box.style.display = 'flex';
  updateFundingDisplay();
  calcDateWeight();
}

function recalcAll() {
  if (currentMode === 'students') calcFromStudents();
  else calcFromEft();
}

function updateFundingDisplay() {
  const naBox     = document.getElementById('fundingNa');
  const resultBox = document.getElementById('fundingResult');

  if (!currentProg || computedEftTotal === null) {
    naBox.style.display = 'none';
    resultBox.style.display = 'none';
    updateWeightedFunding(null, null);
    return;
  }

  const rate = currentProg[fundingIndex[currentFunding]];

  if (rate === null) {
    naBox.style.display = 'block';
    resultBox.style.display = 'none';
    updateWeightedFunding(null, null);
    return;
  }

  naBox.style.display = 'none';
  const total = computedEftTotal * rate;
  document.getElementById('fundingValue').textContent   = formatCurrency(total);
  document.getElementById('fundingFormula').textContent = `${computedEftTotal.toFixed(4)} EFT √ó ${formatCurrency(rate)} = ${formatCurrency(total)}`;
  resultBox.style.display = 'flex';
  updateWeightedFunding(rate, total);
}

function formatCurrency(val) {
  return '$' + val.toLocaleString('en-NZ', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

// Called after year weighting is known, to update weighted funding result
let currentYearPct = 0;
function updateWeightedFunding(rate, baseFundingTotal) {
  const box = document.getElementById('weightedFundingBox');
  if (rate === null || baseFundingTotal === null || currentYearPct === 0) {
    box.style.display = 'none';
    return;
  }
  const weighted = baseFundingTotal * currentYearPct;
  document.getElementById('weightedFundingValue').textContent   = formatCurrency(weighted);
  document.getElementById('weightedFundingFormula').textContent =
    `${formatCurrency(baseFundingTotal)} √ó ${(currentYearPct * 100).toFixed(1)}% = ${formatCurrency(weighted)}`;
  box.style.display = 'flex';
}

// --- Date logic ---

function onStartDateChange() {
  endDateManuallySet = false; // reset when start changes
  applyDefaultEndDate();
  calcDateWeight();
}

function applyDefaultEndDate() {
  const startVal = document.getElementById('startDate').value;
  if (!startVal || !currentWeeks || endDateManuallySet) return;

  const start = new Date(startVal + 'T00:00:00');

  // We want the programme to have exactly currentWeeks of EFT-eligible weeks.
  // Iterate: keep extending end date until effectiveDays(start, end)/7 >= currentWeeks.
  // Start with a naive estimate, then add shutdown days if needed.
  let candidateMs = start.getTime() + currentWeeks * 7 * 86400000;
  let end = new Date(candidateMs);

  // Iteratively bump the end date until effective weeks >= currentWeeks
  // (capped at 200 iterations to avoid infinite loop)
  for (let i = 0; i < 200; i++) {
    const effDays = effectiveDays(start, end);
    const effWeeks = effDays / 7;
    if (effWeeks >= currentWeeks - 0.001) break;
    // Add the shortfall in days
    const shortfallDays = Math.ceil((currentWeeks - effWeeks) * 7);
    end = new Date(end.getTime() + shortfallDays * 86400000);
  }

  const yyyy = end.getFullYear();
  const mm   = String(end.getMonth() + 1).padStart(2, '0');
  const dd   = String(end.getDate()).padStart(2, '0');
  document.getElementById('endDate').value = `${yyyy}-${mm}-${dd}`;
  document.getElementById('autoEndBadge').style.display = 'inline-block';
  document.getElementById('endDateNote').style.display  = 'block';
}

// When user manually edits end date
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('endDate').addEventListener('input', () => {
    endDateManuallySet = true;
    document.getElementById('autoEndBadge').style.display = 'none';
    document.getElementById('endDateNote').style.display  = 'none';
    calcDateWeight();
  });
});

function effectiveDays(rangeStart, rangeEnd) {
  if (rangeEnd <= rangeStart) return 0;
  const startYear = rangeStart.getFullYear();
  const endYear   = rangeEnd.getFullYear();
  const shutdowns = [];
  for (let y = startYear - 1; y <= endYear + 1; y++) {
    shutdowns.push([new Date(y, 11, 14), new Date(y + 1, 0, 15)]);
  }
  let totalMs = rangeEnd - rangeStart;
  let shutdownMs = 0;
  shutdowns.forEach(([sS, sE]) => {
    const oS = rangeStart > sS ? rangeStart : sS;
    const oE = rangeEnd   < sE ? rangeEnd   : sE;
    if (oE > oS) shutdownMs += oE - oS;
  });
  return Math.max(0, totalMs - shutdownMs) / 86400000;
}

function calcDateWeight() {
  const startVal = document.getElementById('startDate').value;
  const endVal   = document.getElementById('endDate').value;
  const container = document.getElementById('dateResults');

  if (!startVal || !endVal) { container.style.display = 'none'; currentYearPct = 0; updateFundingDisplay(); return; }

  const start = new Date(startVal + 'T00:00:00');
  const end   = new Date(endVal   + 'T00:00:00');
  if (end <= start) { container.style.display = 'none'; currentYearPct = 0; updateFundingDisplay(); return; }

  const currentYear = new Date().getFullYear();
  document.getElementById('currentYearLabel').textContent = currentYear;

  // Total calendar days (including shutdown) ‚Äî used for "delivery length"
  const totalCalendarDays  = (end - start) / 86400000;
  const totalCalendarWeeks = totalCalendarDays / 7;

  // Total EFT-eligible days (excluding shutdown) ‚Äî used for EFT weighting
  const totalEffectiveDays  = effectiveDays(start, end);
  const totalEffectiveWeeks = totalEffectiveDays / 7;

  // How many shutdown days overlap this class?
  const shutdownDaysTotal = totalCalendarDays - totalEffectiveDays;

  // Clip to current year for EFT weeks in year
  const yearStart = new Date(currentYear, 0, 1);
  const yearEnd   = new Date(currentYear + 1, 0, 1);

  const overlapStart = start < yearStart ? yearStart : start;
  const overlapEnd   = end   > yearEnd   ? yearEnd   : end;

  let weeksInYear = 0;
  let pct = 0;

  if (overlapEnd > overlapStart) {
    const effectiveInYear = effectiveDays(overlapStart, overlapEnd);
    weeksInYear = effectiveInYear / 7;
    // Percentage = EFT weeks in this year / total EFT weeks for the programme
    pct = totalEffectiveDays > 0 ? effectiveInYear / totalEffectiveDays : 0;
  }

  currentYearPct = pct;

  // Shutdown notice ‚Äî check if shutdown overlaps
  const shutdownChecks = [
    [new Date(currentYear - 1, 11, 14), new Date(currentYear, 0, 15)],
    [new Date(currentYear, 11, 14),     new Date(currentYear + 1, 0, 15)],
  ];
  let shutdownMsg = '';
  let shutdownWeeks = 0;
  shutdownChecks.forEach(([sS, sE]) => {
    if (start < sE && end > sS) {
      const oS = start > sS ? start : sS;
      const oE = end   < sE ? end   : sE;
      if (oE > oS) {
        shutdownWeeks += (oE - oS) / 86400000 / 7;
        const sY = sS.getFullYear();
        shutdownMsg = `Holiday shutdown (14 Dec ${sY} ‚Äì 15 Jan ${sY + 1}) overlaps with this class. ` +
          `${shutdownWeeks.toFixed(2)} shutdown week(s) are included in the total calendar length but excluded from EFT-counted weeks.`;
      }
    }
  });
  const notice = document.getElementById('shutdownNotice');
  notice.style.display = shutdownMsg ? 'block' : 'none';
  if (shutdownMsg) document.getElementById('shutdownText').textContent = shutdownMsg;

  document.getElementById('totalWeeks').textContent  = totalCalendarWeeks.toFixed(2);
  document.getElementById('eftWeeks').textContent    = totalEffectiveWeeks.toFixed(2);
  document.getElementById('weeksInYear').textContent = weeksInYear.toFixed(2);
  document.getElementById('yearPercent').textContent = (pct * 100).toFixed(1) + '%';

  container.style.display = 'block';

  const weightedStudentsBox = document.getElementById('weightedStudentsBox');

  if (computedEftTotal !== null) {
    const weighted = computedEftTotal * pct;
    document.getElementById('weightedEft').textContent      = weighted.toFixed(4);
    document.getElementById('weightFormula').textContent    =
      `${computedEftTotal.toFixed(4)} √ó ${(pct * 100).toFixed(1)}% = ${weighted.toFixed(4)}`;

    let noteHtml = `Programme runs <strong>${totalCalendarWeeks.toFixed(2)} calendar weeks</strong> in total`;
    if (shutdownWeeks > 0) {
      noteHtml += ` (including <strong>${shutdownWeeks.toFixed(2)} shutdown week(s)</strong>)`;
    }
    noteHtml += `, with <strong>${totalEffectiveWeeks.toFixed(2)} EFT-counted weeks</strong>. ` +
      `<strong>${weeksInYear.toFixed(2)} EFT weeks</strong> fall within ${currentYear} ` +
      `(<strong>${(pct * 100).toFixed(1)}%</strong>). ` +
      `Year-weighted EFT = <strong>${weighted.toFixed(4)}</strong>.`;
    document.getElementById('dateNote').innerHTML = noteHtml;

    if (currentMode === 'eft' && currentEftRate && pct > 0) {
      const exactW   = computedEftTotal / (pct * currentEftRate);
      const roundedW = Math.ceil(exactW);
      weightedStudentsBox.style.display = 'flex';
      document.getElementById('weightedStudentsResult').textContent  = roundedW;
      document.getElementById('weightedStudentsFormula').textContent = `Exact: ${exactW.toFixed(3)} ‚Üí ‚Üë${roundedW}`;
    } else {
      weightedStudentsBox.style.display = 'none';
    }
  } else {
    document.getElementById('weightedEft').textContent   = '‚Äî';
    document.getElementById('weightFormula').textContent = 'Complete Steps 1 & 2 to see weighted EFT';
    let noteHtml = `Programme runs <strong>${totalCalendarWeeks.toFixed(2)} calendar weeks</strong> in total`;
    if (shutdownWeeks > 0) {
      noteHtml += ` (including <strong>${shutdownWeeks.toFixed(2)} shutdown week(s)</strong>)`;
    }
    noteHtml += `, with <strong>${totalEffectiveWeeks.toFixed(2)} EFT-counted weeks</strong>. ` +
      `<strong>${weeksInYear.toFixed(2)} EFT weeks</strong> fall within ${currentYear} ` +
      `(<strong>${(pct * 100).toFixed(1)}%</strong>). Select a programme and enter values above to see weighted EFT.`;
    document.getElementById('dateNote').innerHTML = noteHtml;
    weightedStudentsBox.style.display = 'none';
  }

  // Refresh funding with updated pct
  updateFundingDisplay();
}
</script>
</body>
</html>
